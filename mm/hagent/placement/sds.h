#ifndef HAGENT_PLACEMENT_SDS_H
#define HAGENT_PLACEMENT_SDS_H

#include <linux/prime_numbers.h>
#include <linux/xxhash.h>

#include "utils.h"
#include "module.h"

// clang-format off
static inline u64 streaming_decaying_sketch_powb(u64 exp) {
	static u64 const powers[] = {1ull,1ull,1ull,1ull,1ull,1ull,1ull,1ull,1ull,1ull,2ull,2ull,2ull,2ull,2ull,3ull,3ull,3ull,3ull,4ull,4ull,5ull,5ull,5ull,6ull,6ull,7ull,7ull,8ull,9ull,10ull,10ull,11ull,12ull,13ull,14ull,15ull,17ull,18ull,20ull,21ull,23ull,25ull,27ull,29ull,31ull,34ull,37ull,40ull,43ull,46ull,50ull,54ull,59ull,63ull,68ull,74ull,80ull,86ull,93ull,101ull,109ull,118ull,127ull,137ull,148ull,160ull,173ull,187ull,202ull,218ull,236ull,254ull,275ull,297ull,321ull,346ull,374ull,404ull,436ull,471ull,509ull,550ull,594ull,642ull,693ull,748ull,808ull,873ull,943ull,1018ull,1100ull,1188ull,1283ull,1386ull,1497ull,1616ull,1746ull,1885ull,2036ull,2199ull,2375ull,2565ull,2771ull,2992ull,3232ull,3490ull,3770ull,4071ull,4397ull,4749ull,5129ull,5539ull,5982ull,6461ull,6978ull,7536ull,8139ull,8790ull,9493ull,10252ull,11073ull,11959ull,12915ull,13949ull,15065ull,16270ull,17571ull,18977ull,20495ull,22135ull,23906ull,25818ull,27884ull,30115ull,32524ull,35126ull,37936ull,40971ull,44248ull,47788ull,51611ull,55740ull,60200ull,65016ull,70217ull,75834ull,81901ull,88453ull,95529ull,103172ull,111426ull,120340ull,129967ull,140364ull,151594ull,163721ull,176819ull,190964ull,206242ull,222741ull,240560ull,259805ull,280589ull,303037ull,327280ull,353462ull,381739ull,412278ull,445261ull,480881ull,519352ull,560900ull,605772ull,654234ull,706573ull,763099ull,824147ull,890078ull,961285ull,1038187ull,1121242ull,1210942ull,1307817ull,1412443ull,1525438ull,1647473ull,1779271ull,1921613ull,2075342ull,2241369ull,2420679ull,2614333ull,2823480ull,3049359ull,3293307ull,3556772ull,3841314ull,4148619ull,4480508ull,4838949ull,5226065ull,5644150ull,6095682ull,6583337ull,7110004ull,7678804ull,8293109ull,8956557ull,9673082ull,10446929ull,11282683ull,12185298ull,13160122ull,14212931ull,15349966ull,16577963ull,17904200ull,19336536ull,20883459ull,22554136ull,24358467ull,26307144ull,28411716ull,30684653ull,33139426ull,35790580ull,38653826ull,41746132ull,45085823ull,48692689ull,52588104ull,56795152ull,61338765ull,66245866ull,71545535ull,77269178ull,83450712ull,90126769ull,97336911ull,105123864ull,113533773ull,122616475ull,132425793ull,143019856ull,154461445ull,166818360ull,180163829ull,194576936ull,210143091ull,226954538ull,245110901ull,264719773ull,285897355ull,308769143ull,333470675ull,360148329ull,388960195ull,420077011ull,453683172ull,489977826ull,529176052ull,571510136ull,617230947ull,666609423ull,719938177ull,777533231ull,839735889ull,906914760ull,979467941ull,1057825377ull,1142451407ull,1233847519ull,1332555321ull,1439159747ull,1554292526ull,1678635929ull,1812926803ull,1957960947ull,2114597823ull,2283765649ull,2466466901ull,2663784253ull,2876886993ull,3107037953ull,3355600989ull,3624049068ull,3913972994ull,4227090833ull,4565258100ull,4930478748ull,5324917048ull,5750910412ull,6210983244ull,6707861904ull,7244490856ull,7824050125ull,8449974135ull,9125972066ull,9856049831ull,10644533818ull,11496096523ull,12415784245ull,13409046985ull,14481770744ull,15640312403ull,16891537395ull,18242860387ull,19702289218ull,21278472356ull,22980750144ull,24819210156ull,26804746968ull,28949126726ull,31265056864ull,33766261413ull,36467562326ull,39384967312ull,42535764697ull,45938625873ull,49613715943ull,53582813218ull,57869438276ull,62498993338ull,67498912805ull,72898825829ull,78730731895ull,85029190447ull,91831525683ull,99178047738ull,107112291557ull,115681274881ull,124935776872ull,134930639022ull,145725090143ull,157383097355ull,169973745143ull,183571644755ull,198257376335ull,214117966442ull,231247403758ull,249747196058ull,269726971743ull,291305129482ull,314609539841ull,339778303028ull,366960567271ull,396317412652ull,428022805665ull,462264630118ull,499245800527ull,539185464569ull,582320301735ull,628905925874ull,679218399944ull,733555871939ull,792240341694ull,855619569030ull,924069134553ull,997994665317ull,1077834238542ull,1164060977626ull,1257185855836ull,1357760724303ull,1466381582247ull,1583692108827ull,1710387477533ull,1847218475735ull,1994995953794ull,2154595630098ull,2326963280506ull,2513120342946ull,2714169970382ull,2931303568012ull,3165807853454ull,3419072481730ull,3692598280268ull,3988006142690ull,4307046634105ull,4651610364833ull,5023739194020ull,5425638329542ull,5859689395905ull,6328464547578ull,6834741711384ull,7381521048295ull,7972042732158ull,8609806150731ull,9298590642789ull,10042477894213ull,10845876125750ull,11713546215810ull,12650629913075ull,13662680306121ull,14755694730610ull,15936150309059ull,17211042333784ull,18587925720487ull,20074959778126ull,21680956560376ull,23415433085206ull,25288667732022ull,27311761150584ull,29496702042631ull,31856438206042ull,34404953262525ull,37157349523527ull,40129937485409ull,43340332484242ull,46807559082981ull,50552163809620ull,54596336914389ull,58964043867541ull,63681167376944ull,68775660767099ull,74277713628467ull,80219930718745ull,86637525176245ull,93568527190344ull,101054009365572ull,109138330114818ull,117869396524003ull,127298948245923ull,137482864105597ull,148481493234045ull,160360012692769ull,173188813708190ull,187043918804845ull,202007432309233ull,218168026893972ull,235621469045490ull,254471186569129ull,274828881494659ull,296815192014232ull,320560407375371ull,346205239965400ull,373901659162633ull,403813791895643ull,436118895247295ull,471008406867078ull,508689079416445ull,549384205769760ull,593334942231341ull,640801737609849ull,692065876618637ull,747431146748128ull,807225638487978ull,871803689567016ull,941547984732378ull,1016871823510968ull,1098221569391845ull,1186079294943193ull,1280965638538649ull,1383442889621741ull,1494118320791480ull,1613647786454799ull,1742739609371183ull,1882158778120877ull,2032731480370548ull,2195349998800192ull,2370977998704207ull,2560656238600544ull,2765508737688588ull,2986749436703675ull,3225689391639969ull,3483744542971166ull,3762444106408860ull,4063439634921569ull,4388514805715295ull,4739595990172519ull,5118763669386321ull,5528264762937227ull,5970525943972206ull,6448168019489983ull,6964021461049182ull,7521143177933117ull,8122834632167767ull,8772661402741189ull,9474474314960484ull,10232432260157324ull,11051026840969910ull,11935108988247504ull,12889917707307306ull,13921111123891892ull,15034800013803244ull,16237584014907504ull,17536590736100106ull,18939517994988116ull,20454679434587170ull,22091053789354144ull,23858338092502476ull,25767005139902676ull,27828365551094892ull,30054634795182484ull,32459005578797084ull,35055726025100852ull,37860184107108920ull,40888998835677640ull,44160118742531860ull,47692928241934410ull,51508362501289170ull,55629031501392300ull,60079354021503700ull,64885702343223990ull,70076558530681910ull,75682683213136460ull,81737297870187400ull,88276281699802380ull,95338384235786580ull,102965454974649500ull,111202691372621470ull,120098906682431200ull,129706819217025710ull,140083364754387780ull,151290033934738800ull,163393236649517920ull,176464695581479360ull,190581871227997730ull,205828420926237570ull,222294694600336580ull,240078270168363520ull,259284531781832600ull,280027294324379230ull,302429477870329600ull,326623836099956000ull,352753742987952450ull,380974042426988700ull,411451965821147800ull,444368123086839600ull,479917572933786800ull,518310978768489800ull,559775857069969000ull,604557925635566600ull,652922559686411900ull,705156364461324900ull,761568873618230900ull,822494383507689500ull,888293934188304600ull,959357448923369100ull,1036106044837238700ull,1118994528424217900ull,1208514090698155300ull,1305195217954007800ull,1409610835390328600ull,1522379702221555000ull,1644170078399279400ull,1775703684671221800ull,1917759979444919600ull,2071180777800513300ull,2236875240024554500ull,2415825259226519000ull,2609091279964641000ull,2817818582361812000ull,3043244068950757400ull,3286703594466818000ull,3549639882024164000ull,3833611072586097000ull,4140299958392985000ull,4471523955064424000ull,4829245871469578000ull,5215585541187145000ull,5632832384482117000ull,6083458975240687000ull,6570135693259942000ull,7095746548720737000ull,7663406272618397000ull,8276478774427869000ull,8938597076382099000ull,9653684842492668000ull,10425979629892082000ull,11260058000283450000ull,12160862640306127000ull,13133731651530619000ull,14184430183653069000ull,15319184598345314000ull,16544719366212940000ull,17868296915509977000ull};
	static u64 const len = ARRAY_SIZE(powers);
	return exp < len ? powers[exp] : powers[len - 1];
}
// clang-format on

struct streaming_decaying_sketch {
	u64 w, d;
	struct streaming_decaying_sketch_slot {
		u16 fingerprint, count;
	} *slots;
};

static inline u64 streaming_decaying_sketch_hash(u64 key, u64 i)
{
	return xxh64(&key, sizeof(key), 0x25BBE08F + i);
}

static inline void
streaming_decaying_sketch_drop(struct streaming_decaying_sketch *s)
{
	if (s->slots) {
		kvfree(s->slots);
	}
}

static inline int __must_check
streaming_decaying_sketch_init(struct streaming_decaying_sketch *s, u64 w,
			       u64 d)
{
	s->w = w;
	s->d = d;
	s->slots = kvcalloc(sizeof(struct streaming_decaying_sketch_slot),
			    d * w, GFP_KERNEL);
	if (!s->slots) {
		return -ENOMEM;
	}
	return 0;
}

static inline struct streaming_decaying_sketch_slot *
streaming_decaying_sketch_at(struct streaming_decaying_sketch *s, u64 i, u64 j)
{
	return &s->slots[i * s->w + j];
}

// clang-format off
#define streaming_decaying_sketch_for_each_slot_of(sds, key, hash, slot)			\
	for (u64 __i = 0, __depth = (sds)->d, __width = (sds)->w, __done; __i < __depth; ++__i) \
		for ((hash) = streaming_decaying_sketch_hash((key), __i),			\
		    (slot) = streaming_decaying_sketch_at((sds), __i, (hash) % __width),	\
		    __done = 0; !__done; __done = 1)
// clang-format on

static inline u16
streaming_decaying_sketch_get(struct streaming_decaying_sketch *s, u64 key)
{
	u16 count = 0;
	u64 hash;
	struct streaming_decaying_sketch_slot *slot;
	streaming_decaying_sketch_for_each_slot_of(s, key, hash, slot)
	{
		if (slot->fingerprint != (u16)hash) {
			continue;
		}
		count = max(slot->count, count);
	}
	return count;
}

static inline u16
streaming_decaying_sketch_push(struct streaming_decaying_sketch *s, u64 key)
{
	// pr_info_ratelimited("%s: key=0x%llx\n", __func__, key);
	u16 count = 0;
	u64 hash;
	struct streaming_decaying_sketch_slot *slot;
	streaming_decaying_sketch_for_each_slot_of(s, key, hash, slot)
	{
		u16 fingerprint = hash;
		u16 *f = &slot->fingerprint, *c = &slot->count;
		if (*f == fingerprint) {
			*c = min((u16)(*c + 1), (u16)SHRT_MAX);
		} else {
			// empty slot or decay with probability
			if (0 ==
			    mt19937() % streaming_decaying_sketch_powb(*c)) {
				// pr_info_ratelimited(
				// 	"%s: decaying key=0x%llx i=%llu fingerprint=0x%x count=%u\n",
				// 	__func__, key, i, *f, *c);
				*c = saturating_sub(*c, (u16)1);
				if (*c == 0) {
					*f = fingerprint;
					*c = 1;
				}
			}
		}
		count = max(*c, count);
	}
	return count;
}

static inline void streaming_decaying_sketch_update_param(void)
{
	if (streaming_decaying_sketch_width == SDS_WIDTH) {
		// The original implementation has 2000 < W < 12000.
		// When giving b = 1.08, N = 10^7, ε = 2^−16 or 2^−17,
		// the error rate is within (0.01,0.05)
		// if we choose W = 7000, we have W = 7/10000 of N
		u64 spanned = 0;
		int nid;
		for_each_node_state(nid, N_MEMORY) {
			spanned += NODE_DATA(nid)->node_spanned_pages;
		}
		streaming_decaying_sketch_width =
			next_prime_number(spanned * 7 / 10000 / 3);
		pr_info("%s: streaming_decaying_sketch_width=%lu\n", __func__,
			streaming_decaying_sketch_width);
	}
	// leave depth unchanged
}

#endif // !HAGENT_PLACEMENT_SDS_H
